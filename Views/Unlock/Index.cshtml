@{
    ViewData["Title"] = "Unlock User Account";
    Layout = "_Layout";
}

<div class="container-fluid px-3">
    <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8 col-xl-6">
            <div class="card pulse-glow">
                <div class="card-header text-center">
                    <div class="position-relative mb-3">
                        <i class="fas fa-unlock-alt fa-2x" style="color: var(--color-warning);"></i>
                        <div class="circuit-line position-absolute" style="bottom: -10px; left: 25%; right: 25%; height: 1px;"></div>
                    </div>
                    <h3 class="card-title mb-0">
                        Unlock User Account
                    </h3>
                    <p class="mb-0 mt-2" style="opacity: 0.9; font-size: 0.95rem;">
                        Secure account unlock with full audit trail
                    </p>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(ViewBag.Success))
                    {
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            <i class="fas fa-check-circle me-2"></i>
                            @ViewBag.Success
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(ViewBag.Error))
                    {
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            @ViewBag.Error
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(ViewBag.ElevateAccount))
                    {
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Permission Structure</h6>
                            <p class="mb-2">Your access hierarchy:</p>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="permission-item mb-2">
                                        <i class="fas fa-user text-primary me-2"></i>
                                        <strong>SSO Account:</strong><br>
                                        <small class="text-muted">@User.Identity?.Name</small>
                                    </div>
                                    <div class="permission-item mb-2">
                                        <i class="fas fa-key text-warning me-2"></i>
                                        <strong>Elevate Account:</strong><br>
                                        <small class="text-muted">@ViewBag.ElevateAccount</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="permission-item mb-2">
                                        <i class="fas fa-building text-success me-2"></i>
                                        <strong>Tenant ID:</strong><br>
                                        <small class="text-muted">@ViewBag.TenantId</small>
                                    </div>
                                    <div class="permission-item mb-2">
                                        <i class="fas fa-layer-group text-info me-2"></i>
                                        <strong>Tier & Role Access:</strong><br>
                                        <small class="text-muted">Determines available options</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    }

                    <form method="post">
                        <div class="mb-3">
                            <label for="username" class="form-label">
                                <i class="fas fa-user me-1"></i>
                                Username <span class="text-danger">*</span>
                            </label>
                            <input type="text" class="form-control @(ViewData.ModelState["username"]?.Errors.Count > 0 ? "is-invalid" : "")" 
                                   id="username" name="username" value="@@Request.Form["username"]" 
                                   placeholder="Enter the username to unlock" required>
                            @if (ViewData.ModelState["username"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">
                                    @ViewData.ModelState["username"].Errors[0].ErrorMessage
                                </div>
                            }
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-server me-1" style="color: var(--color-success);"></i>
                                Target Servers <span class="text-danger">*</span>
                                <span class="badge ms-2" id="server-count" style="background: var(--color-secondary-dark);">0 selected</span>
                            </label>
                            @{
                                var availableServers = ViewBag.Servers as List<string> ?? new List<string>();
                            }
                            @if (availableServers.Any())
                            {
                                <div class="mb-3 d-flex flex-wrap gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-success flex-fill flex-sm-grow-0" id="select-all-servers">
                                        <i class="fas fa-check-double me-1"></i><span class="d-none d-sm-inline">Select </span>All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary flex-fill flex-sm-grow-0" id="clear-all-servers">
                                        <i class="fas fa-times me-1"></i>Clear<span class="d-none d-sm-inline"> All</span>
                                    </button>
                                </div>
                                <div class="server-checkbox-container @(ViewData.ModelState["servers"]?.Errors.Count > 0 ? "border-danger" : "")" style="max-height: 220px; overflow-y: auto; padding: 1.5rem;">
                                    <div class="row">
                                        @foreach (var server in availableServers)
                                        {
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check p-3" style="border: 1px solid var(--color-light-neutral); border-radius: var(--border-radius-sm); background: rgba(255,255,255,0.8); transition: var(--transition-fast);">
                                                    <input class="form-check-input server-checkbox" type="checkbox" name="servers" value="@server" id="server-@server.Replace(".", "-").Replace(" ", "-")">
                                                    <label class="form-check-label w-100" for="server-@server.Replace(".", "-").Replace(" ", "-")" style="cursor: pointer;">
                                                        <i class="fas fa-server me-2" style="color: var(--color-success);"></i>
                                                        <strong>@server</strong>
                                                        <br><small class="text-muted">Server instance</small>
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No servers available for your permissions. Please contact your administrator.
                                </div>
                            }
                            @if (ViewData.ModelState["servers"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback d-block">
                                    @ViewData.ModelState["servers"].Errors[0].ErrorMessage
                                </div>
                            }
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Available servers are based on your tier permissions. Select one or more servers where the account should be unlocked.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-users-cog me-1" style="color: var(--color-warning);"></i>
                                User Roles <span class="text-danger">*</span>
                                <span class="badge ms-2" id="role-count" style="background: var(--color-secondary-dark);">0 selected</span>
                            </label>
                            @{
                                var availableRoles = ViewBag.Roles as List<string> ?? new List<string>();
                            }
                            @if (availableRoles.Any())
                            {
                                <div class="mb-3 d-flex flex-wrap gap-2">
                                    <button type="button" class="btn btn-sm btn-outline-warning flex-fill flex-sm-grow-0" id="select-all-roles">
                                        <i class="fas fa-check-double me-1"></i><span class="d-none d-sm-inline">Select </span>All
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary flex-fill flex-sm-grow-0" id="clear-all-roles">
                                        <i class="fas fa-times me-1"></i>Clear<span class="d-none d-sm-inline"> All</span>
                                    </button>
                                </div>
                                <div class="role-checkbox-container @(ViewData.ModelState["roles"]?.Errors.Count > 0 ? "border-danger" : "")" style="max-height: 220px; overflow-y: auto; padding: 1.5rem;">
                                    <div class="row">
                                        @foreach (var role in availableRoles)
                                        {
                                            <div class="col-md-6 mb-3">
                                                <div class="form-check p-3" style="border: 1px solid var(--color-light-neutral); border-radius: var(--border-radius-sm); background: rgba(255,255,255,0.8); transition: var(--transition-fast);">
                                                    <input class="form-check-input role-checkbox" type="checkbox" name="roles" value="@role" id="role-@role.Replace(" ", "-").Replace("&", "and")">
                                                    <label class="form-check-label w-100" for="role-@role.Replace(" ", "-").Replace("&", "and")" style="cursor: pointer;">
                                                        <i class="fas fa-users-cog me-2" style="color: var(--color-warning);"></i>
                                                        <strong>@role</strong>
                                                        <br><small class="text-muted">Permission role</small>
                                                    </label>
                                                </div>
                                            </div>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    No roles available for your permissions. Please contact your administrator.
                                </div>
                            }
                            @if (ViewData.ModelState["roles"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback d-block">
                                    @ViewData.ModelState["roles"].Errors[0].ErrorMessage
                                </div>
                            }
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Available roles are based on your account permissions. Select one or more roles to grant during the unlock operation.
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="reason" class="form-label">
                                <i class="fas fa-comment me-1"></i>
                                Reason for Unlock <span class="text-danger">*</span>
                            </label>
                            <textarea class="form-control @(ViewData.ModelState["reason"]?.Errors.Count > 0 ? "is-invalid" : "")" 
                                      id="reason" name="reason" rows="3" 
                                      placeholder="Enter the reason for unlocking this account" required>@@Request.Form["reason"]</textarea>
                            @if (ViewData.ModelState["reason"]?.Errors.Count > 0)
                            {
                                <div class="invalid-feedback">
                                    @ViewData.ModelState["reason"].Errors[0].ErrorMessage
                                </div>
                            }
                            <div class="form-text">
                                Please provide a detailed reason for the unlock request for audit purposes.
                            </div>
                        </div>

                        <div class="mb-4">
                            <div class="card" style="background: linear-gradient(135deg, rgba(42, 20, 80, 0.05) 0%, rgba(113, 191, 68, 0.05) 100%); border: 1px solid var(--color-light-neutral);">
                                <div class="card-header" style="background: transparent; border-bottom: 1px solid var(--color-light-neutral); padding: 1rem;">
                                    <h6 class="mb-0">
                                        <i class="fas fa-clipboard-list me-2" style="color: var(--color-primary-dark);"></i>
                                        Request Summary
                                    </h6>
                                </div>
                                <div class="card-body py-3">
                                    <div class="row">
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-user me-2" style="color: var(--color-success);"></i>
                                                <div>
                                                    <small class="text-muted">Requested by</small><br>
                                                    <strong style="color: var(--color-primary-dark);">@User.Identity?.Name</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-key me-2" style="color: var(--color-warning);"></i>
                                                <div>
                                                    <small class="text-muted">Elevate Account</small><br>
                                                    <strong style="color: var(--color-primary-dark);">@ViewBag.ElevateAccount</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-building me-2" style="color: var(--color-success);"></i>
                                                <div>
                                                    <small class="text-muted">Tenant ID</small><br>
                                                    <strong style="color: var(--color-primary-dark);">@ViewBag.TenantId</strong>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 mb-2">
                                            <div class="d-flex align-items-center">
                                                <i class="fas fa-clock me-2" style="color: var(--color-warning);"></i>
                                                <div>
                                                    <small class="text-muted">Request Time</small><br>
                                                    <strong style="color: var(--color-primary-dark);">@DateTime.Now.ToString("yyyy-MM-dd HH:mm:ss")</strong>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="@Url.Action("Index", "Home")" class="btn btn-outline-secondary me-md-2">
                                <i class="fas fa-home me-2"></i>
                                Back to Dashboard
                            </a>
                            <button type="submit" class="btn btn-success btn-lg pulse-glow" id="submitBtn">
                                <i class="fas fa-paper-plane me-2"></i>
                                Execute Unlock Request
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="mt-4">
                <div class="alert alert-warning" role="alert" style="border-left: 4px solid var(--color-warning);">
                    <div class="d-flex align-items-start">
                        <i class="fas fa-shield-alt me-3 mt-1" style="color: var(--color-warning); font-size: 1.2rem;"></i>
                        <div>
                            <h6 class="alert-heading mb-2">Security Notice</h6>
                            <p class="mb-2">All unlock requests are comprehensively logged and audited for compliance purposes.</p>
                            <small>
                                <i class="fas fa-info-circle me-1"></i>
                                Ensure you have proper authorization before proceeding with this privileged operation.
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Enhanced Checkbox Management with Visual Feedback
        function updateCount(checkboxClass, countId) {
            const checkboxes = document.querySelectorAll(`.${checkboxClass}`);
            const checkedCount = document.querySelectorAll(`.${checkboxClass}:checked`).length;
            const countElement = document.getElementById(countId);
            
            if (countElement) {
                countElement.textContent = `${checkedCount} selected`;
                if (checkedCount > 0) {
                    countElement.style.background = 'var(--gradient-success)';
                    countElement.className = 'badge ms-2';
                } else {
                    countElement.style.background = 'var(--color-secondary-dark)';
                    countElement.className = 'badge ms-2';
                }
            }
            
            // Add visual feedback to form-check containers
            checkboxes.forEach(checkbox => {
                const container = checkbox.closest('.form-check');
                if (container) {
                    if (checkbox.checked) {
                        container.style.background = 'rgba(113, 191, 68, 0.1)';
                        container.style.borderColor = 'var(--color-success)';
                        container.style.transform = 'scale(1.02)';
                        container.style.boxShadow = '0 2px 8px rgba(113, 191, 68, 0.2)';
                    } else {
                        container.style.background = 'rgba(255,255,255,0.8)';
                        container.style.borderColor = 'var(--color-light-neutral)';
                        container.style.transform = 'scale(1)';
                        container.style.boxShadow = 'none';
                    }
                }
            });
        }

        // Server checkbox management
        document.getElementById('select-all-servers')?.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.server-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateCount('server-checkbox', 'server-count');
        });

        document.getElementById('clear-all-servers')?.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.server-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateCount('server-checkbox', 'server-count');
        });

        // Role checkbox management
        document.getElementById('select-all-roles')?.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.role-checkbox');
            checkboxes.forEach(cb => cb.checked = true);
            updateCount('role-checkbox', 'role-count');
        });

        document.getElementById('clear-all-roles')?.addEventListener('click', function() {
            const checkboxes = document.querySelectorAll('.role-checkbox');
            checkboxes.forEach(cb => cb.checked = false);
            updateCount('role-checkbox', 'role-count');
        });

        // Update counts when individual checkboxes are clicked
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('server-checkbox')) {
                updateCount('server-checkbox', 'server-count');
            }
            if (e.target.classList.contains('role-checkbox')) {
                updateCount('role-checkbox', 'role-count');
            }
        });

        // Form submission handling
        document.getElementById('submitBtn').addEventListener('click', function(e) {
            const username = document.getElementById('username').value.trim();
            const reason = document.getElementById('reason').value.trim();
            const selectedServers = document.querySelectorAll('.server-checkbox:checked');
            const selectedRoles = document.querySelectorAll('.role-checkbox:checked');
            
            // Custom validation
            if (!selectedServers.length) {
                e.preventDefault();
                alert('Please select at least one server.');
                document.querySelector('.server-checkbox-container').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            if (!selectedRoles.length) {
                e.preventDefault();
                alert('Please select at least one role.');
                document.querySelector('.role-checkbox-container').scrollIntoView({ behavior: 'smooth' });
                return;
            }
            
            if (!username || !reason) {
                return; // Let HTML5 validation handle this
            }
            
            // Confirmation dialog
            const serverList = Array.from(selectedServers).map(cb => cb.value).join(', ');
            const roleList = Array.from(selectedRoles).map(cb => cb.value).join(', ');
            
            const confirmMessage = `Are you sure you want to unlock "${username}"?\n\nServers: ${serverList}\nRoles: ${roleList}`;
            
            if (!confirm(confirmMessage)) {
                e.preventDefault();
            } else {
                // Show enhanced loading state with circuit animation
                this.innerHTML = '<i class="fas fa-cog fa-spin me-2"></i>Processing Request...';
                this.disabled = true;
                this.style.background = 'var(--gradient-warning)';
                this.style.transform = 'scale(0.98)';
                
                // Add pulsing effect during submission
                this.style.animation = 'pulseGlow 1s ease-in-out infinite';
            }
        });

        // Initialize counts on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateCount('server-checkbox', 'server-count');
            updateCount('role-checkbox', 'role-count');
        });
    </script>
}