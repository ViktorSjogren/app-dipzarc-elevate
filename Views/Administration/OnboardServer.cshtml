@model dizparc_elevate.Models.securitySolutionsCommon.ElevateAdServersWithOnboardingStatusView

@{
    ViewData["Title"] = "Onboard Server";
    Layout = "_Layout";
    var availableTiers = ViewBag.AvailableTiers as List<dizparc_elevate.Models.securitySolutionsCommon.ElevateAvailableTier> ?? new List<dizparc_elevate.Models.securitySolutionsCommon.ElevateAvailableTier>();
}

<style>
    .tier-select {
        background-color: #2A1450 !important;
        border: 1px solid rgba(255,255,255,0.2) !important;
        color: white !important;
    }
    .tier-select:focus {
        background-color: #2A1450 !important;
        border-color: var(--color-primary) !important;
        box-shadow: 0 0 0 0.25rem rgba(var(--color-primary-rgb), 0.25) !important;
        color: white !important;
    }
    .tier-select option {
        background-color: #2A1450;
        color: white;
        padding: 10px;
    }
    .tier-select option:hover,
    .tier-select option:focus,
    .tier-select option:checked {
        background-color: #3d2070;
        color: white;
    }
</style>

<div class="page-wrapper-fixed">
    <div class="page-content-section" style="padding-top: 56px; height: calc(100vh - 56px);">
        <div class="container-fluid h-100">
            <div class="row justify-content-center align-items-center h-100">
                <div class="col-md-6 col-lg-5">
                    <div class="card" style="background: rgba(42, 20, 80, 0.95); border: 2px solid var(--color-primary-dark); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-secondary-dark) 100%); border-bottom: 2px solid var(--color-primary-dark);">
                            <h4 class="text-white mb-0">
                                <i class="fas fa-server me-2 text-warning"></i>
                                Onboard Server
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            <div class="mb-4 p-3" style="background: rgba(255,255,255,0.05); border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-server me-2 text-primary"></i>
                                    <span class="text-primary-light opacity-70">Server Name:</span>
                                </div>
                                <h5 class="text-white mb-0 ms-4">@Model.ServerName</h5>
                            </div>

                            <div id="errorAlert" class="alert d-none" style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); color: #f8d7da;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <span id="errorMessage"></span>
                            </div>

                            <div id="successAlert" class="alert d-none" style="background: rgba(25, 135, 84, 0.1); border: 1px solid rgba(25, 135, 84, 0.3); color: #d1e7dd;">
                                <i class="fas fa-check-circle me-2"></i>
                                <span id="successMessage"></span>
                            </div>

                            <div id="processingAlert" class="alert d-none" style="background: rgba(13, 110, 253, 0.1); border: 1px solid rgba(13, 110, 253, 0.3); color: #cfe2ff;">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <span id="processingMessage">Starting onboarding process...</span>
                            </div>

                            <form id="onboardForm">
                                @Html.AntiForgeryToken()
                                <input type="hidden" id="serverName" value="@Model.ServerName" />

                                <div class="mb-4">
                                    <label for="tier" class="form-label text-primary-light">
                                        <i class="fas fa-layer-group me-1"></i>
                                        Select Tier <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select tier-select" id="tier" name="tier" required>
                                        <option value="" disabled selected>-- Select a tier --</option>
                                        @foreach (var tier in availableTiers)
                                        {
                                            <option value="@tier.ElevateAvailableTiersId">@tier.DisplayName</option>
                                        }
                                    </select>
                                    <small class="form-text text-primary-light opacity-70">
                                        Select the security tier for this server. This determines the device group it will be added to.
                                    </small>
                                </div>

                                <div id="tierDescription" class="mb-4 p-3 d-none" style="background: rgba(255,255,255,0.03); border-radius: 8px; border-left: 3px solid var(--color-primary);">
                                    <h6 id="tierDisplayName" class="text-warning mb-2"></h6>
                                </div>

                                <div class="d-flex justify-content-between mt-4">
                                    <a href="@Url.Action("OnboardedServers", "Administration")" class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-1"></i>Cancel
                                    </a>
                                    <button type="submit" class="btn btn-primary" id="submitBtn">
                                        <i class="fas fa-arrow-right me-1"></i>Next
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const tierSelect = document.getElementById('tier');
        const tierDescription = document.getElementById('tierDescription');
        const form = document.getElementById('onboardForm');
        const submitBtn = document.getElementById('submitBtn');
        const errorAlert = document.getElementById('errorAlert');
        const errorMessage = document.getElementById('errorMessage');
        const successAlert = document.getElementById('successAlert');
        const successMessage = document.getElementById('successMessage');
        const processingAlert = document.getElementById('processingAlert');
        const processingMessage = document.getElementById('processingMessage');
        const serverName = document.getElementById('serverName').value;

        tierSelect.addEventListener('change', function() {
            if (this.value !== '') {
                tierDescription.classList.remove('d-none');
                const selectedOption = this.options[this.selectedIndex];
                document.getElementById('tierDisplayName').textContent = selectedOption.text;
            } else {
                tierDescription.classList.add('d-none');
            }
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            const tier = tierSelect.value;
            if (tier === '') { showError('Please select a tier.'); return; }
            hideAlerts();
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
            processingAlert.classList.remove('d-none');

            try {
                const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                const response = await fetch('@Url.Action("StartServerOnboarding", "Administration")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `serverName=${encodeURIComponent(serverName)}&tier=${tier}&__RequestVerificationToken=${encodeURIComponent(token)}`
                });
                const result = await response.json();
                if (result.success) {
                    processingAlert.classList.add('d-none');
                    successAlert.classList.remove('d-none');
                    successMessage.textContent = result.message;
                    pollServerStatus();
                } else {
                    processingAlert.classList.add('d-none');
                    showError(result.error || 'An error occurred.');
                    resetButton();
                }
            } catch (error) {
                processingAlert.classList.add('d-none');
                showError('A network error occurred. Please try again.');
                resetButton();
            }
        });

        function showError(message) { errorAlert.classList.remove('d-none'); errorMessage.textContent = message; }
        function hideAlerts() { errorAlert.classList.add('d-none'); successAlert.classList.add('d-none'); processingAlert.classList.add('d-none'); }
        function resetButton() { submitBtn.disabled = false; submitBtn.innerHTML = '<i class="fas fa-arrow-right me-1"></i>Next'; }

        async function pollServerStatus() {
            processingAlert.classList.remove('d-none');
            processingMessage.textContent = 'Automation is running. Waiting for completion...';
            successAlert.classList.add('d-none');

            const checkInterval = setInterval(async () => {
                try {
                    const response = await fetch(`@Url.Action("CheckServerOnboardingStatus", "Administration")?serverName=${encodeURIComponent(serverName)}`);
                    const result = await response.json();
                    if (result.success) {
                        if (result.status === 2) {
                            clearInterval(checkInterval);
                            processingAlert.classList.add('d-none');
                            successAlert.classList.remove('d-none');
                            successMessage.textContent = 'Automation completed! Redirecting to manual steps...';
                            setTimeout(() => {
                                window.location.href = '@Url.Action("OnboardServerProgress", "Administration")?serverName=' + encodeURIComponent(serverName);
                            }, 1500);
                        } else if (result.status === 0) {
                            clearInterval(checkInterval);
                            processingAlert.classList.add('d-none');
                            showError('Automation job failed. Please try again.');
                            resetButton();
                        }
                    }
                } catch (error) { console.error('Error polling status:', error); }
            }, 5000);
        }
    });
</script>
