@{
    ViewData["Title"] = "Create User";
    Layout = "_Layout";
    var availableTiers = ViewBag.AvailableTiers as List<dizparc_elevate.Models.securitySolutionsCommon.ElevateAvailableTier> ?? new List<dizparc_elevate.Models.securitySolutionsCommon.ElevateAvailableTier>();
}

<div class="page-wrapper-fixed">
    <div class="page-content-section" style="padding-top: 6px; height: calc(100vh - 56px);">
        <div class="container-fluid h-100">
            <div class="row justify-content-center align-items-center h-100">
                <div class="col-md-6 col-lg-5">
                    <div class="card" style="background: rgba(42, 20, 80, 0.95); border: 2px solid var(--color-primary-dark); box-shadow: 0 10px 30px rgba(0,0,0,0.5);">
                        <div class="card-header" style="background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-secondary-dark) 100%); border-bottom: 2px solid var(--color-primary-dark);">
                            <h4 class="text-white mb-0">
                                <i class="fas fa-user-plus me-2 text-warning"></i>
                                Create New User
                            </h4>
                        </div>
                        <div class="card-body p-4">
                            @if (!ViewData.ModelState.IsValid)
                            {
                                <div style="background: rgba(220, 53, 69, 0.1); border: 1px solid rgba(220, 53, 69, 0.3); color: #f8d7da; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem;">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>Please correct the following errors:</strong>
                                    <ul class="mb-0 mt-2">
                                        @foreach (var modelError in ViewData.ModelState.Where(x => x.Value?.Errors?.Count > 0))
                                        {
                                            foreach (var error in modelError.Value.Errors)
                                            {
                                                <li>@error.ErrorMessage</li>
                                            }
                                        }
                                    </ul>
                                </div>
                            }

                            @if (TempData["ADJobId"] != null)
                            {
                                <div style="background: rgba(13, 110, 253, 0.1); border: 1px solid rgba(13, 110, 253, 0.3); color: #cfe2ff; border-radius: 0.375rem; padding: 1rem; margin-bottom: 1rem;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Active Directory account creation initiated. Job ID: @TempData["ADJobId"]
                                </div>
                            }

                            <form id="createUserForm" method="post" action="@Url.Action("AddUser", "Administration")">
                                @Html.AntiForgeryToken()

                                <!-- Username (Entra ID search) -->
                                <div class="mb-3 position-relative">
                                    <label for="userNameSearch" class="form-label text-primary-light">
                                        <i class="fas fa-user me-1"></i>
                                        Username <span class="text-danger">*</span>
                                    </label>
                                    <input type="hidden" id="userName" name="userName" required>
                                    <input type="text"
                                           class="form-control"
                                           id="userNameSearch"
                                           placeholder="Search Entra ID users..."
                                           autocomplete="off"
                                           style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); color: white;"
                                           required>
                                    <div id="entraSearchResults" class="entra-dropdown" style="display:none;"></div>
                                    <small class="form-text text-primary-light opacity-70">
                                        Search by name or email to find the Entra ID user
                                    </small>
                                </div>

                                <!-- Elevate Account -->
                                <div class="mb-3">
                                    <label for="elevateAccount" class="form-label text-primary-light">
                                        <i class="fas fa-id-badge me-1"></i>
                                        Elevate Account <span class="text-danger">*</span>
                                    </label>
                                    <input type="text"
                                           class="form-control"
                                           id="elevateAccount"
                                           name="elevateAccount"
                                           placeholder="Enter elevate account"
                                           style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); color: white;"
                                           required>
                                    <small class="form-text text-primary-light opacity-70">
                                        The unique elevate account identifier
                                    </small>
                                </div>

                                <!-- Phone Number -->
                                <div class="mb-3">
                                    <label for="phoneNumber" class="form-label text-primary-light">
                                        <i class="fas fa-phone me-1"></i>
                                        Phone Number <span class="text-danger">*</span>
                                    </label>
                                    <input type="tel"
                                           class="form-control"
                                           id="phoneNumber"
                                           name="phoneNumber"
                                           placeholder="Enter phone number"
                                           style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); color: white;"
                                           required>
                                    <small class="form-text text-primary-light opacity-70">
                                        Contact phone number for the user
                                    </small>
                                </div>

                                <!-- Tier -->
                                <div class="mb-4">
                                    <label for="tier" class="form-label text-primary-light">
                                        <i class="fas fa-layer-group me-1"></i>
                                        Tier <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-control"
                                            id="tier"
                                            name="tier"
                                            style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); color: white;"
                                            required>
                                        <option value="" style="background: #2A1450;">-- Select a tier --</option>
                                        @foreach (var tier in availableTiers)
                                        {
                                            <option value="@tier.ElevateAvailableTiersId" style="background: #2A1450;">@tier.DisplayName</option>
                                        }
                                    </select>
                                    <small class="form-text text-primary-light opacity-70">
                                        Determines which permissions are available for this user
                                    </small>
                                </div>

                                <!-- Action Buttons -->
                                <div class="d-flex justify-content-between">
                                    <a href="@Url.Action("UserAdministration", "Administration")"
                                       class="btn btn-outline-secondary">
                                        <i class="fas fa-arrow-left me-1"></i>
                                        Cancel
                                    </a>
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-save me-1"></i>
                                        Create User
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>

                    <!-- Help Text -->
                    <div class="mt-3 text-center">
                        <small class="text-primary-light opacity-70">
                            <i class="fas fa-question-circle me-1"></i>
                            All fields marked with <span class="text-danger">*</span> are required
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('userNameSearch');
        const hiddenInput = document.getElementById('userName');
        const resultsDiv = document.getElementById('entraSearchResults');
        let debounceTimer = null;

        searchInput.addEventListener('input', function() {
            const query = this.value.trim();
            hiddenInput.value = '';
            searchInput.classList.remove('is-valid');
            clearTimeout(debounceTimer);
            if (query.length < 2) { resultsDiv.style.display = 'none'; return; }

            debounceTimer = setTimeout(async () => {
                try {
                    const response = await fetch('@Url.Action("SearchEntraUsers", "Administration")?query=' + encodeURIComponent(query));
                    const users = await response.json();
                    if (!users.length) {
                        resultsDiv.innerHTML = '<div class="entra-item text-muted"><i class="fas fa-search me-2"></i>No users found</div>';
                        resultsDiv.style.display = 'block';
                        return;
                    }
                    resultsDiv.innerHTML = users.map(u => `
                        <div class="entra-item" data-upn="${u.userPrincipalName}">
                            <div><strong>${u.displayName || ''}</strong></div>
                            <small style="color: rgba(255,255,255,0.6);">${u.userPrincipalName || ''}</small>
                            ${u.mail ? `<small style="color: rgba(255,255,255,0.6);" class="ms-2">(${u.mail})</small>` : ''}
                        </div>
                    `).join('');
                    resultsDiv.style.display = 'block';
                    resultsDiv.querySelectorAll('.entra-item[data-upn]').forEach(item => {
                        item.addEventListener('click', function() {
                            const upn = this.getAttribute('data-upn');
                            const name = this.querySelector('strong').textContent;
                            hiddenInput.value = upn;
                            searchInput.value = name + ' (' + upn + ')';
                            searchInput.classList.add('is-valid');
                            searchInput.classList.remove('is-invalid');
                            resultsDiv.style.display = 'none';
                        });
                    });
                } catch (err) {
                    console.error('Entra search error:', err);
                    resultsDiv.innerHTML = '<div class="entra-item text-danger"><i class="fas fa-exclamation-triangle me-2"></i>Search failed</div>';
                    resultsDiv.style.display = 'block';
                }
            }, 300);
        });

        document.addEventListener('click', function(e) {
            if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                resultsDiv.style.display = 'none';
            }
        });

        const form = document.getElementById('createUserForm');
        const visibleInputs = form.querySelectorAll('#elevateAccount, #phoneNumber, #tier');
        visibleInputs.forEach(input => {
            input.addEventListener('blur', function() {
                if (this.value.trim() === '') { this.classList.add('is-invalid'); this.classList.remove('is-valid'); }
                else { this.classList.add('is-valid'); this.classList.remove('is-invalid'); }
            });
        });

        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            let isValid = true;
            if (!hiddenInput.value.trim()) { searchInput.classList.add('is-invalid'); searchInput.classList.remove('is-valid'); isValid = false; }
            visibleInputs.forEach(input => { if (input.value.trim() === '') { input.classList.add('is-invalid'); isValid = false; } });
            if (!isValid) { alert('Please fill in all required fields. Make sure to select a user from the search results.'); return; }

            const formData = {
                userName: document.getElementById('userName').value.trim(),
                elevateAccount: document.getElementById('elevateAccount').value.trim(),
                phoneNumber: document.getElementById('phoneNumber').value.trim(),
                tier: document.getElementById('tier').value.trim()
            };

            const submitBtn = form.querySelector('button[type="submit"]');
            const originalButtonContent = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';

            const cancelBtn = form.querySelector('a.btn-outline-secondary');
            if (cancelBtn) cancelBtn.style.display = 'none';

            try {
                const url = '/Administration/AddUser';
                const params = new URLSearchParams();
                params.append('userName', formData.userName);
                params.append('elevateAccount', formData.elevateAccount);
                params.append('phoneNumber', formData.phoneNumber);
                params.append('tier', formData.tier);
                params.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]').value);

                const response = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: params.toString() });
                if (!response.ok) {
                    const contentType = response.headers.get('content-type');
                    if (contentType && contentType.includes('application/json')) { const errorResult = await response.json(); throw new Error(errorResult.error || `Server error: ${response.status}`); }
                    else { throw new Error(`Server error: ${response.status} - ${response.statusText}`); }
                }
                const result = await response.json();
                if (!result.success) { submitBtn.disabled = false; submitBtn.innerHTML = originalButtonContent; if (cancelBtn) cancelBtn.style.display = ''; showError(result.error || 'Failed to create user'); return; }

                window.location.href = '@Url.Action("UserAdministration", "Administration")';
            } catch (error) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalButtonContent;
                if (cancelBtn) cancelBtn.style.display = '';
                showError(error.message || 'Network error. Please check your connection and try again.');
            }
        });

        function showError(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top:20px;right:20px;z-index:10000;min-width:300px;';
            alertDiv.innerHTML = `<i class="fas fa-exclamation-triangle me-2"></i><strong>Error:</strong> ${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alertDiv);
            setTimeout(() => { if (document.body.contains(alertDiv)) document.body.removeChild(alertDiv); }, 10000);
        }

        const phoneInput = document.getElementById('phoneNumber');
        phoneInput.addEventListener('input', function(e) { e.target.value = e.target.value.replace(/[^\d+-]/g, ''); });
    });
</script>

<style>
    .form-control.is-invalid { border-color: #dc3545 !important; }
    .form-control.is-valid { border-color: #28a745 !important; }
    .form-control { color: white !important; }
    .form-control::placeholder { color: rgba(255,255,255,0.45) !important; }
    .form-control:focus { background: rgba(255,255,255,0.1) !important; border-color: var(--color-warning) !important; box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important; color: white !important; }
    select.form-control option { background: #2A1450; color: white; }
    .entra-dropdown { position: absolute; top: 100%; left: 0; right: 0; z-index: 1050; max-height: 250px; overflow-y: auto; background: #2A1450; border: 1px solid rgba(255,255,255,0.2); border-top: none; border-radius: 0 0 0.375rem 0.375rem; box-shadow: 0 4px 12px rgba(0,0,0,0.4); }
    .entra-item { padding: 8px 12px; cursor: pointer; color: white; border-bottom: 1px solid rgba(255,255,255,0.05); }
    .entra-item:hover { background: rgba(255,255,255,0.1); }
    .entra-item:last-child { border-bottom: none; }
</style>
