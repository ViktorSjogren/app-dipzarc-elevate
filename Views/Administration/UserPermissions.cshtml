@model IEnumerable<dizparc_elevate.Models.securitySolutionsCommon.ElevateUserPermissionsView>

@{
    ViewData["Title"] = "User Permissions";
    Layout = "_Layout";
    var tierLookup = ViewBag.TierDisplayLookup as Dictionary<string, string> ?? new Dictionary<string, string>();
}

<div class="page-wrapper-fixed">
    <div class="page-content-section" style="padding-top: 6px; height: calc(100vh - 56px);">
        <div class="layout-with-blade" style="height: 100%;">
            <!-- Left Blade (25%) -->
            <div class="layout-blade" style="height: 100%;">
                <div class="blade-container" style="background: linear-gradient(180deg, rgba(42, 20, 80, 0.98) 0%, rgba(42, 20, 80, 0.92) 100%); border-right: 3px solid var(--color-primary-dark); box-shadow: 2px 0 10px rgba(0,0,0,0.3); height: 100%;">
                    <div class="blade-header" style="padding: .5rem 1rem; margin-bottom: 0.75rem; border-bottom: 2px solid var(--color-primary-dark); background: rgba(0,0,0,0.3);">
                        <h3 class="mb-1 text-primary-light"><i class="fas fa-user-shield me-2" style="color: var(--color-warning);"></i>User Permissions</h3>
                        <h6 class="mb-0 text-primary-light opacity-70"><i class="fas fa-filter me-2"></i>Filters & Search</h6>
                    </div>

                    <div class="blade-section" style="padding: 0.75rem 1rem; margin-bottom: 0.75rem;">
                        <button class="btn btn-primary btn-sm w-100 mb-2" id="applyFilters" style="font-size: 0.8rem; padding: 0.5rem;"><i class="fas fa-check me-1"></i>Apply Filters</button>
                        <button class="btn btn-primary btn-sm w-100 mb-2" id="clearFilters" style="font-size: 0.8rem; padding: 0.5rem;"><i class="fas fa-times me-1"></i>Clear All</button>
                        <a href="@Url.Action("Index", "Administration")" class="btn btn-outline-secondary btn-sm w-100" style="font-size: 0.8rem; padding: 0.5rem;"><i class="fas fa-arrow-left me-1"></i>Back to Admin</a>
                    </div>

                    <div class="blade-section" style="padding: 0.75rem 1rem; margin-bottom: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div class="blade-section-title text-primary-light" style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">SEARCH</div>
                        <div class="filter-group" style="margin-bottom: 0.5rem;">
                            <input type="text" class="form-control form-control-sm" id="searchUser" placeholder="Search by user..." style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: white;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <input type="text" class="form-control form-control-sm" id="searchAccount" placeholder="Search by account..." style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: white;">
                        </div>
                    </div>

                    <div class="blade-section" style="padding: 0.75rem 1rem; margin-bottom: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div class="blade-section-title text-primary-light" style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">PERMISSION TYPE</div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <div class="form-check" style="margin-bottom: 0.25rem;">
                                <input class="form-check-input" type="checkbox" value="server" id="filterServer" checked>
                                <label class="form-check-label text-primary-light" for="filterServer" style="font-size: 0.875rem;"><i class="fas fa-server me-1 text-primary-light" style="opacity: 0.7;"></i>Server</label>
                            </div>
                            <div class="form-check" style="margin-bottom: 0;">
                                <input class="form-check-input" type="checkbox" value="role" id="filterRole" checked>
                                <label class="form-check-label text-primary-light" for="filterRole" style="font-size: 0.875rem;"><i class="fas fa-users me-1 text-primary-light" style="opacity: 0.7;"></i>Role</label>
                            </div>
                        </div>
                    </div>

                    <div class="blade-section" style="padding: 0.75rem 1rem; margin-bottom: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div class="blade-section-title text-primary-light" style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">TIER LEVEL</div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <select class="form-select form-select-sm" id="filterTier" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: white;">
                                <option value="">All Tiers</option>
                                @if (Model != null)
                                {
                                    @foreach (var tierLevel in Model.Select(p => p.TierLevel).Where(t => !string.IsNullOrEmpty(t)).Distinct().OrderBy(t => t))
                                    {
                                        <option value="@tierLevel">@(tierLookup.ContainsKey(tierLevel) ? tierLookup[tierLevel] : tierLevel)</option>
                                    }
                                }
                            </select>
                        </div>
                    </div>

                    <div class="blade-section" style="padding: 0.75rem 1rem; margin-bottom: 0.75rem; background: rgba(255,255,255,0.03); border-radius: 8px;">
                        <div class="blade-section-title text-primary-light" style="font-size: 0.75rem; margin-bottom: 0.5rem; opacity: 0.8;">DATE GRANTED</div>
                        <div class="filter-group" style="margin-bottom: 0.5rem;">
                            <input type="date" class="form-control form-control-sm" id="dateFrom" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: white;">
                        </div>
                        <div class="filter-group" style="margin-bottom: 0;">
                            <input type="date" class="form-control form-control-sm" id="dateTo" style="background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.15); color: white;">
                        </div>
                    </div>

                    <div class="blade-section" style="padding: 0.75rem 1rem; margin-bottom: 0.75rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px;">
                        <div class="blade-section-title text-primary-light mb-2" style="font-size: 0.75rem; opacity: 0.8;">SUMMARY</div>
                        @if (Model != null && Model.Any())
                        {
                            <div class="text-primary-light" style="font-size: 0.875rem;">
                                <div class="d-flex justify-content-between mb-1"><span style="opacity: 0.8;">Permissions:</span><span class="fw-bold">@Model.Count()</span></div>
                                <div class="d-flex justify-content-between"><span style="opacity: 0.8;">Unique Users:</span><span class="fw-bold">@Model.Select(p => p.UserName).Distinct().Count()</span></div>
                            </div>
                        }
                        else
                        {
                            <small class="text-primary-light" style="opacity: 0.8;">No data available</small>
                        }
                    </div>
                </div>
            </div>

            <!-- Right Main Content (75%) -->
            <div class="layout-main" style="padding: 0; display: flex; flex-direction: column; height: 100%;">
                @if (Model != null && Model.Any())
                {
                    <div style="overflow-y: auto; flex: 1; height: 100%; padding: 0;">
                        <table class="table table-striped table-hover mb-0" style="margin: 0;">
                            <thead class="table-header-gradient position-sticky" style="top: 0; z-index: 10; background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-secondary-dark) 100%);">
                                <tr>
                                    <th style="padding: 0.5rem;">User Name</th>
                                    <th style="padding: 0.5rem;">Elevate Account</th>
                                    <th style="padding: 0.5rem;">Permission Type</th>
                                    <th style="padding: 0.5rem;">Permission Value</th>
                                    <th style="padding: 0.5rem;">Tier Level</th>
                                    <th style="padding: 0.5rem;">Granted</th>
                                    <th style="padding: 0.5rem;">Granted By</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var permission in Model)
                                {
                                    <tr class="permission-row"
                                        data-username="@permission.UserName?.ToLower()"
                                        data-account="@permission.ElevateAccount?.ToLower()"
                                        data-type="@permission.PermissionType?.ToLower()"
                                        data-tier="@permission.TierLevel"
                                        data-granted="@(permission.PermissionGranted.HasValue ? permission.PermissionGranted.Value.ToString("yyyy-MM-dd") : "")">
                                        <td style="padding: 0.4rem 0.5rem;"><i class="fas fa-user me-1 icon-primary" style="font-size: 0.8rem;"></i><strong style="font-size: 0.875rem;">@permission.UserName</strong></td>
                                        <td style="padding: 0.4rem 0.5rem;"><code style="font-size: 0.8rem;">@permission.ElevateAccount</code></td>
                                        <td style="padding: 0.4rem 0.5rem;">
                                            @if (permission.PermissionType.Equals("server", StringComparison.OrdinalIgnoreCase))
                                            { <span class="badge bg-primary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"><i class="fas fa-server me-1"></i>Server</span> }
                                            else if (permission.PermissionType.Equals("role", StringComparison.OrdinalIgnoreCase))
                                            { <span class="badge bg-info" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;"><i class="fas fa-users me-1"></i>Role</span> }
                                            else
                                            { <span class="badge bg-secondary" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">@permission.PermissionType</span> }
                                        </td>
                                        <td style="padding: 0.4rem 0.5rem;"><code style="font-size: 0.8rem;">@permission.PermissionValue</code></td>
                                        <td style="padding: 0.4rem 0.5rem;">
                                            @if (!string.IsNullOrEmpty(permission.TierLevel))
                                            { <span class="badge bg-warning text-dark" style="font-size: 0.75rem; padding: 0.25rem 0.5rem;">@(tierLookup.ContainsKey(permission.TierLevel) ? tierLookup[permission.TierLevel] : permission.TierLevel)</span> }
                                            else { <small class="text-muted" style="font-size: 0.75rem;">N/A</small> }
                                        </td>
                                        <td style="padding: 0.4rem 0.5rem;">
                                            @if (permission.PermissionGranted.HasValue) { <small style="font-size: 0.8rem;">@permission.PermissionGranted.Value.ToString("yyyy-MM-dd HH:mm")</small> }
                                            else { <small class="text-muted" style="font-size: 0.75rem;">N/A</small> }
                                        </td>
                                        <td style="padding: 0.4rem 0.5rem;"><small style="font-size: 0.8rem;">@permission.GrantedBy</small></td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="d-flex align-items-center justify-content-center h-100">
                        <div class="alert alert-warning" role="alert"><i class="fas fa-exclamation-triangle me-2"></i>No user permissions found.</div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const searchUser = document.getElementById('searchUser');
        const searchAccount = document.getElementById('searchAccount');
        const filterServer = document.getElementById('filterServer');
        const filterRole = document.getElementById('filterRole');
        const filterTier = document.getElementById('filterTier');
        const dateFrom = document.getElementById('dateFrom');
        const dateTo = document.getElementById('dateTo');
        const applyBtn = document.getElementById('applyFilters');
        const clearBtn = document.getElementById('clearFilters');

        function applyFilters() {
            const rows = document.querySelectorAll('.permission-row');
            const userSearch = searchUser.value.toLowerCase();
            const accountSearch = searchAccount.value.toLowerCase();
            const showServer = filterServer.checked;
            const showRole = filterRole.checked;
            const tierFilter = filterTier.value;
            const fromDate = dateFrom.value;
            const toDate = dateTo.value;
            rows.forEach(row => {
                let show = true;
                if (userSearch && !row.dataset.username.includes(userSearch)) show = false;
                if (accountSearch && !row.dataset.account.includes(accountSearch)) show = false;
                const rowType = row.dataset.type;
                if (rowType === 'server' && !showServer) show = false;
                if (rowType === 'role' && !showRole) show = false;
                if (tierFilter && row.dataset.tier !== tierFilter) show = false;
                const grantedDate = row.dataset.granted;
                if (fromDate && grantedDate && grantedDate < fromDate) show = false;
                if (toDate && grantedDate && grantedDate > toDate) show = false;
                row.style.display = show ? '' : 'none';
            });
        }
        function clearFilters() { searchUser.value = ''; searchAccount.value = ''; filterServer.checked = true; filterRole.checked = true; filterTier.value = ''; dateFrom.value = ''; dateTo.value = ''; applyFilters(); }
        applyBtn.addEventListener('click', applyFilters);
        clearBtn.addEventListener('click', clearFilters);
        searchUser.addEventListener('input', applyFilters);
        searchAccount.addEventListener('input', applyFilters);
        filterServer.addEventListener('change', applyFilters);
        filterRole.addEventListener('change', applyFilters);
        filterTier.addEventListener('change', applyFilters);
        dateFrom.addEventListener('change', applyFilters);
        dateTo.addEventListener('change', applyFilters);
    });
</script>

<style>
    #filterTier option { background-color: #2A1450; color: white; }
    input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); opacity: 0.5; }
    input[type="date"]::-webkit-calendar-picker-indicator:hover { opacity: 0.8; }
</style>
